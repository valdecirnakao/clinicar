<div class="container mt-0 mb-0" style="color:#35689b;">
  <div class="row justify-content-center">
    <div class="col-md-12 mt-sm-0">

      <!-- Título / Cabeçalho -->
      <div class="row mt-0">
        <div class="col text-center mb-2">
          <div class="card" style="border:1px solid #d0e2f2;border-radius:3px;background:#eef6ff;">
            <div class="card-body fw-semibold">Fornecedores</div>
          </div>
        </div>
      </div>

      <!-- Toolbar -->
      <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-2">
        <div class="input-group" style="max-width:420px;">
          <span class="input-group-text" style="background:#eef6ff;border-color:#d0e2f2;color:#35689b;">Buscar</span>
          <input #q type="search" class="form-control"
                 placeholder="CNPJ, Razão Social ou Nome Fantasia"
                 (input)="filtrar(q.value)" />
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" type="button" (click)="recarregar()"
                  style="border-color:#d0e2f2;color:#35689b;">
            Atualizar
          </button>
        </div>
      </div>

      <!-- Estados globais -->
      <div *ngIf="loading" class="alert alert-info py-2">Carregando fornecedores…</div>
      <div *ngIf="!loading && errorMsg" class="alert alert-danger py-2">{{ errorMsg }}</div>

      <!-- Tabela -->
      <div class="table-responsive">
        <table class="table align-middle table-hover text-nowrap" style="border-color:#d0e2f2;">
          <thead style="background:#eef6ff;color:#35689b;">
            <tr>
              <th>CNPJ</th>
              <th>Razão Social</th>
              <th>Nome Fantasia</th>
              <th>Item Fornecido</th>
              <th>Telefone</th>
              <th>Email</th>
              <th>Fundação</th>
              <th>CEP</th>
              <th>Logradouro</th>
              <th>Número</th>
              <th>Complemento</th>
              <th>Bairro</th>
              <th>Cidade</th>
              <th>UF</th>
              <th class="text-center">Ações</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let f of fornecedores; trackBy: trackByFornecedor"
                [class.table-active]="editId === f.id"
                [class.editing]="editId === f.id"><!-- <- habilita quebra apenas na linha em edição -->

              <!-- CNPJ -->
              <td>
                <ng-container *ngIf="editId !== f.id; else edit_cnpj">
                {{ formatarCNPJ(f.cnpj) }} <!-- << formatado -->
                </ng-container>
                  <ng-template #edit_cnpj>
                    <input class="form-control form-control-sm"
                      [(ngModel)]="edit.cnpj"
                      [attr.name]="'cnpj_' + (f.id ?? f.cnpj)"
                      autocomplete="off">
                  </ng-template>
              </td>

              <!-- Razão Social -->
              <td>
                <ng-container *ngIf="editId !== f.id; else edit_razao">
                  {{ f.razaoSocial }}
                </ng-container>
                <ng-template #edit_razao>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.razaoSocial"
                         [attr.name]="'razao_' + (f.id ?? f.cnpj)">
                </ng-template>
              </td>

              <!-- Nome Fantasia -->
              <td>
                <ng-container *ngIf="editId !== f.id; else edit_nomefant">
                  {{ f.nomeFantasia }}
                </ng-container>
                <ng-template #edit_nomefant>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.nomeFantasia"
                         [attr.name]="'nomeFantasia_' + (f.id ?? f.cnpj)">
                </ng-template>
              </td>

              <!-- Item Fornecido -->
              <td>
                <ng-container *ngIf="editId !== f.id; else edit_item">
                  {{ f.itemFornecido }}
                </ng-container>
                <ng-template #edit_item>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.itemFornecido"
                         [attr.name]="'item_' + (f.id ?? f.cnpj)">
                </ng-template>
              </td>

              <!-- Telefone -->
              <td>
                <ng-container *ngIf="editId !== f.id; else edit_tel">
                  {{ f.telefone }}
                </ng-container>
                <ng-template #edit_tel>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.telefone"
                         [attr.name]="'tel_' + (f.id ?? f.cnpj)">
                </ng-template>
              </td>

              <!-- Email -->
              <td>
                <ng-container *ngIf="editId !== f.id; else edit_email">
                  {{ f.email }}
                </ng-container>
                <ng-template #edit_email>
                  <input type="email" class="form-control form-control-sm"
                         [(ngModel)]="edit.email"
                         [attr.name]="'email_' + (f.id ?? f.cnpj)">
                </ng-template>
              </td>

              <!-- Fundação -->
              <td>
                <ng-container *ngIf="editId !== f.id; else edit_funda">
                  {{ f.fundacao | date:'dd/MM/yyyy' }}
                </ng-container>
                <ng-template #edit_funda>
                  <input type="date" class="form-control form-control-sm"
                         [(ngModel)]="edit.fundacao"
                         [attr.name]="'fundacao_' + (f.id ?? f.cnpj)">
                </ng-template>
              </td>

              <!-- CEP -->
              <td>
                <ng-container *ngIf="editId !== f.id; else edit_cep">
                  {{ formatarCEP(f.cep) }} <!-- << formatado -->
                </ng-container>
                <ng-template #edit_cep>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.cep"
                         [attr.name]="'cep_' + (f.id ?? f.cnpj)"
                         (blur)="onCepBlurRow(edit)"
                         >
                </ng-template>
              </td>

              <!-- Logradouro -->
              <td>
                <ng-container *ngIf="editId !== f.id; else edit_logr">
                  {{ f.logradouro }}
                </ng-container>
                <ng-template #edit_logr>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.logradouro"
                         [attr.name]="'logradouro_' + (f.id ?? f.cnpj)">
                </ng-template>
              </td>

              <!-- Número -->
              <td style="min-width: 90px;">
                <ng-container *ngIf="editId !== f.id; else edit_num">
                  {{ f.numeroEndereco }}
                </ng-container>
                <ng-template #edit_num>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.numeroEndereco"
                         [attr.name]="'numero_' + (f.id ?? f.cnpj)">
                </ng-template>
              </td>

              <!-- Complemento -->
              <td>
                <ng-container *ngIf="editId !== f.id; else edit_comp">
                  {{ f.complementoEndereco }}
                </ng-container>
                <ng-template #edit_comp>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.complementoEndereco"
                         [attr.name]="'compl_' + (f.id ?? f.cnpj)">
                </ng-template>
              </td>

              <!-- Bairro -->
              <td>
                <ng-container *ngIf="editId !== f.id; else edit_bairro">
                  {{ f.bairro }}
                </ng-container>
                <ng-template #edit_bairro>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.bairro"
                         [attr.name]="'bairro_' + (f.id ?? f.cnpj)">
                </ng-template>
              </td>

              <!-- Cidade -->
              <td>
                <ng-container *ngIf="editId !== f.id; else edit_cidade">
                  {{ f.cidade }}
                </ng-container>
                <ng-template #edit_cidade>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.cidade"
                         [attr.name]="'cidade_' + (f.id ?? f.cnpj)">
                </ng-template>
              </td>

              <!-- UF -->
              <td style="min-width: 64px;">
                <ng-container *ngIf="editId !== f.id; else edit_uf">
                  {{ f.estado }}
                </ng-container>
                <ng-template #edit_uf>
                  <input class="form-control form-control-sm text-uppercase"
                         maxlength="2"
                         [(ngModel)]="edit.estado"
                         [attr.name]="'estado_' + (f.id ?? f.cnpj)">
                </ng-template>
              </td>

              <!-- Ações -->
              <td class="text-center" style="min-width: 160px;">
                <ng-container *ngIf="editId !== f.id; else edit_acoes">
                  <button class="btn btn-sm btn-outline-primary me-1"
                          (click)="iniciarEdicao(f)"
                          style="border-color:#8fb4da;color:#35689b;">
                    Editar
                  </button>
                  <button class="btn btn-sm btn-outline-danger"
                          (click)="excluir(f.id)"
                          style="border-color:#f3c7c7;color:#b03030;">
                    Excluir
                  </button>
                </ng-container>
                <ng-template #edit_acoes>
                  <button class="btn btn-sm btn-success me-1"
                          (click)="salvarEdicao(f.id!)">
                    Salvar
                  </button>
                  <button class="btn btn-sm btn-secondary"
                          (click)="cancelarEdicao()">
                    Cancelar
                  </button>
                </ng-template>
              </td>

            </tr>

            <!-- Sem dados -->
            <tr *ngIf="!fornecedores || fornecedores.length === 0">
              <td colspan="15" class="text-center text-muted py-4">
                Nenhum fornecedor encontrado.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<style>
  /* Bordas/cores padrão */
  .table thead th { border-color: #d0e2f2 !important; }
  .table td, .table th { vertical-align: middle; color: #35689b; }
  .table-hover tbody tr:hover { background-color: #f7fbff; }
  .table-active { --bs-table-bg: #f1f7ff; }

  /* Sem quebras e com elipse por padrão (uma linha por registro) */
  .table.text-nowrap th,
  .table.text-nowrap td {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Linha em edição: mostrar todo o conteúdo (pode quebrar) */
  .table.text-nowrap tr.editing > th,
  .table.text-nowrap tr.editing > td {
    white-space: normal !important;
    overflow: visible !important;
    text-overflow: clip !important;
    word-break: break-word; /* ajuda com textos longos sem espaços */
  }

  /* Inputs na linha em edição com largura mínima confortável */
  .table.text-nowrap tr.editing .form-control {
    min-width: 220px;
  }

  .form-control:focus, .btn:focus {
    box-shadow: 0 0 0 .2rem rgba(53,104,155,.15);
    border-color: #8fb4da;
  }
</style>
