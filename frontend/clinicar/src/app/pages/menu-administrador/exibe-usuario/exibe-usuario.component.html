<div class="container mt-0 mb-0" style="color:#35689b;">
  <div class="row justify-content-center">
    <div class="col-md-12 mt-sm-0">

      <!-- Título / Cabeçalho -->
      <div class="row mt-0">
        <div class="col text-center mb-2">
          <div class="card" style="border:1px solid #d0e2f2;border-radius:3px;background:#eef6ff;">
            <div class="card-body" style="color:#35689b;">Usuários</div>
          </div>
        </div>
      </div>

      <!-- Toolbar -->
      <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-2">
        <div class="input-group" style="max-width:420px; color:#35689b;">
          <span class="input-group-text" style="background:#eef6ff;border-color:#d0e2f2;color:#35689b;">Buscar</span>
          <input #q type="search" class="form-control" style="color:#35689b;"
                 placeholder="CPF, CNPJ, Nome, Nome Social ou E-mail"
                 (input)="filtrar(q.value)" style="color:#35689b;"/>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" type="button" (click)="recarregar()"
                  style="border-color:#d0e2f2;color:#35689b;">
            Atualizar
          </button>
        </div>
      </div>

      <!-- Estados globais -->
      <div *ngIf="loading" class="alert alert-info py-2">Carregando usuarios…</div>
      <div *ngIf="!loading && errorMsg" class="alert alert-danger py-2">{{ errorMsg }}</div>

      <!-- Tabela -->
      <div class="table-responsive">
        <table class="table align-middle table-hover text-nowrap" style="border-color:#d0e2f2;">
          <thead style="background:#eef6ff;color:#35689b;">
            <tr>
              <th>CPF/CNPJ</th>
              <th>Nome</th>
              <th>Nome Social</th>
              <th>E-mail</th>
              <th>Telefone/WhatsApp</th>
              <th>WhatsApp API Key</th>
              <th>Senha</th>
              <th>Nascimento</th>
              <th>CEP</th>
              <th>Logradouro</th>
              <th>Número</th>
              <th>Complemento</th>
              <th>Bairro</th>
              <th>Cidade</th>
              <th>UF</th>
              <th>Tipo do Acesso</th>
              <th class="text-center">Ações</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let u of usuarios; trackBy: trackByUsuario"
                [class.table-active]="editId === u.id"
                [class.editing]="editId === u.id"><!-- <- habilita quebra apenas na linha em edição -->

              <!-- CNPJ/CPF -->
              <td>
                <ng-container *ngIf="editId !== u.id; else edit_cpf">
                {{ formatarCPF(u.cpf) }} <!-- << formatado -->
                </ng-container>
                  <ng-template #edit_cpf>
                    <input class="form-control form-control-sm"
                      [(ngModel)]="edit.cpf"
                      [attr.name]="'cpf_' + (u.id ?? u.cpf)"
                      autocomplete="off">
                  </ng-template>
              </td>

              <!-- Nome -->
              <td>
                <ng-container *ngIf="editId !== u.id; else edit_nome">
                  {{ u.nome }}
                </ng-container>
                <ng-template #edit_nome>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.nome"
                         [attr.name]="'nome_' + (u.id ?? u.cpf)">
                </ng-template>
              </td>

              <!-- Nome Social -->
              <td>
                <ng-container *ngIf="editId !== u.id; else edit_nome_social">
                  {{ u.nome_social }}
                </ng-container>
                <ng-template #edit_nome_social>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.nome_social"
                         [attr.name]="'nome_social_' + (u.id ?? u.cpf)">
                </ng-template>
              </td>

              <!-- E-mail -->
              <td>
                <ng-container *ngIf="editId !== u.id; else edit_email">
                  {{ u.email }}
                </ng-container>
                <ng-template #edit_email>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.email"
                         [attr.name]="'email_' + (u.id ?? u.cpf)">
                </ng-template>
              </td>

              <!-- Telefone/WhatsApp -->
              <td>
                <ng-container *ngIf="editId !== u.id; else edit_tel">
                  {{ u.telefone }}
                </ng-container>
                <ng-template #edit_tel>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.telefone"
                         [attr.name]="'tel_' + (u.id ?? u.cpf)">
                </ng-template>
              </td>

              <!-- WhatsApp API Key -->
              <td>
                <ng-container *ngIf="editId !== u.id; else edit_whatsappapikey">
                  {{ u.whatsappapikey }}
                </ng-container>
                <ng-template #edit_whatsappapikey>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.whatsappapikey"
                         [attr.name]="'whatsappapikey_' + (u.id ?? u.cpf)">
                </ng-template>
              </td>

              <!-- Senha -->
              <td>
                <ng-container *ngIf="editId !== u.id; else edit_senha">
                  {{ u.senha }}
                </ng-container>
                <ng-template #edit_senha>
                  <input type="password" class="form-control form-control-sm"
                         [(ngModel)]="edit.senha"
                         [attr.name]="'senha_' + (u.id ?? u.cpf)">
                </ng-template>
              </td>

              <!-- Nascimento -->
              <td>
                <ng-container *ngIf="editId !== u.id; else edit_nasc">
                  {{ u.nascimento | date:'dd/MM/yyyy' }}
                </ng-container>
                <ng-template #edit_nasc>
                  <input type="date" class="form-control form-control-sm"
                         [(ngModel)]="edit.nascimento"
                         [attr.name]="'nascimento_' + (u.id ?? u.cpf)">
                </ng-template>
              </td>

              <!-- CEP -->
              <td>
                <ng-container *ngIf="editId !== u.id; else edit_cep">
                  {{ formatarCEP(u.cep) }} <!-- << formatado -->
                </ng-container>
                <ng-template #edit_cep>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.cep"
                         [attr.name]="'cep_' + (u.id ?? u.cpf)"
                         (blur)="onCepBlurRow(edit)"
                         >
                </ng-template>
              </td>

              <!-- Logradouro -->
              <td>
                <ng-container *ngIf="editId !== u.id; else edit_logr">
                  {{ u.logradouro }}
                </ng-container>
                <ng-template #edit_logr>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.logradouro"
                         [attr.name]="'logradouro_' + (u.id ?? u.cpf)">
                </ng-template>
              </td>

              <!-- Número -->
              <td style="min-width: 90px;">
                <ng-container *ngIf="editId !== u.id; else edit_num">
                  {{ u.numero_endereco }}
                </ng-container>
                <ng-template #edit_num>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.numero_endereco"
                         [attr.name]="'numero_' + (u.id ?? u.cpf)">
                </ng-template>
              </td>

              <!-- Complemento -->
              <td>
                <ng-container *ngIf="editId !== u.id; else edit_comp">
                  {{ u.complemento_endereco }}
                </ng-container>
                <ng-template #edit_comp>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.complemento_endereco"
                         [attr.name]="'compl_' + (u.id ?? u.cpf)">
                </ng-template>
              </td>

              <!-- Bairro -->
              <td>
                <ng-container *ngIf="editId !== u.id; else edit_bairro">
                  {{ u.bairro }}
                </ng-container>
                <ng-template #edit_bairro>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.bairro"
                         [attr.name]="'bairro_' + (u.id ?? u.cpf)">
                </ng-template>
              </td>

              <!-- Cidade -->
              <td>
                <ng-container *ngIf="editId !== u.id; else edit_cidade">
                  {{ u.cidade }}
                </ng-container>
                <ng-template #edit_cidade>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.cidade"
                         [attr.name]="'cidade_' + (u.id ?? u.cpf)">
                </ng-template>
              </td>

              <!-- UF -->
              <td style="min-width: 64px;">
                <ng-container *ngIf="editId !== u.id; else edit_uf">
                  {{ u.estado }}
                </ng-container>
                <ng-template #edit_uf>
                  <input class="form-control form-control-sm text-uppercase"
                         maxlength="2"
                         [(ngModel)]="edit.estado"
                         [attr.name]="'estado_' + (u.id ?? u.cpf)">
                </ng-template>
              </td>

              <!-- Tipo do Acesso -->
              <td style="min-width: 64px;">
                <ng-container *ngIf="editId !== u.id; else edit_tipo_acesso">
                  {{ u.tipo_do_acesso }}
                </ng-container>
                <ng-template #edit_tipo_acesso>
                  <input class="form-control form-control-sm text-lowercase"
                         maxlength="255"
                         [(ngModel)]="edit.tipo_do_acesso"
                         [attr.name]="'tipo_acesso_' + (u.id ?? u.cpf)">
                </ng-template>
              </td>

              <!-- Ações -->
              <td class="text-center" style="min-width: 160px;">
                <ng-container *ngIf="editId !== u.id; else edit_acoes">
                  <button class="btn btn-sm btn-outline-primary me-1"
                          (click)="iniciarEdicao(u)"
                          style="border-color:#8fb4da;color:#35689b;">
                    Editar
                  </button>
                  <button class="btn btn-sm btn-outline-danger"
                          (click)="excluir(u.id)"
                          style="border-color:#f3c7c7;color:#b03030;">
                    Excluir
                  </button>
                </ng-container>
                <ng-template #edit_acoes>
                  <button class="btn btn-sm btn-success me-1"
                          (click)="salvarEdicao(u.id!)">
                    Salvar
                  </button>
                  <button class="btn btn-sm btn-secondary"
                          (click)="cancelarEdicao()">
                    Cancelar
                  </button>
                </ng-template>
              </td>

            </tr>

            <!-- Sem dados -->
            <tr *ngIf="!usuarios || usuarios.length === 0">
              <td colspan="15" class="text-center text-muted py-4">
                Nenhum usuário encontrado.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<style>
  /* Bordas/cores padrão */
  .table thead th { border-color: #d0e2f2 !important; }
  .table td, .table th { vertical-align: middle; color: #35689b; }
  .table-hover tbody tr:hover { background-color: #f7fbff; }
  .table-active { --bs-table-bg: #f1f7ff; }

  /* Sem quebras e com elipse por padrão (uma linha por registro) */
  .table.text-nowrap th,
  .table.text-nowrap td {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Linha em edição: mostrar todo o conteúdo (pode quebrar) */
  .table.text-nowrap tr.editing > th,
  .table.text-nowrap tr.editing > td {
    white-space: normal !important;
    overflow: visible !important;
    text-overflow: clip !important;
    word-break: break-word; /* ajuda com textos longos sem espaços */
  }

  /* Inputs na linha em edição com largura mínima confortável */
  .table.text-nowrap tr.editing .form-control {
    min-width: 220px;
  }

  .form-control:focus, .btn:focus {
    box-shadow: 0 0 0 .2rem rgba(53,104,155,.15);
    border-color: #8fb4da;
  }
</style>
