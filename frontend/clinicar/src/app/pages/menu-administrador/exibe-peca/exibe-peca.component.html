<div class="container mt-0 mb-0" style="color:#35689b;">
  <div class="row justify-content-center">
    <div class="col-md-12 mt-sm-0">

      <!-- Título / Cabeçalho -->
      <div class="row mt-0">
        <div class="col text-center mb-2">
          <div class="card" style="border:1px solid #d0e2f2;border-radius:3px;background:#eef6ff;">
            <div class="card-body" style="color:#35689b;">Peças</div>
          </div>
        </div>
      </div>

      <!-- Toolbar -->
      <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-2">
        <div class="input-group" style="max-width:420px; color:#35689b;">
          <span class="input-group-text" style="background:#eef6ff;border-color:#d0e2f2;color:#35689b;">Buscar</span>
          <input #q type="search" class="form-control" style="color:#35689b;"
                 placeholder="Nome, Fabricante, Modelo ou Norma"
                 (input)="filtrar(q.value)" style="color:#35689b;"/>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" type="button" (click)="recarregar()"
                  style="border-color:#d0e2f2;color:#35689b;">
            Atualizar
          </button>
        </div>
      </div>

      <!-- Estados globais -->
      <div *ngIf="loading" class="alert alert-info py-2">Carregando peças…</div>
      <div *ngIf="!loading && errorMsg" class="alert alert-danger py-2">{{ errorMsg }}</div>

      <!-- Tabela -->
      <div class="table-responsive">
        <table class="table align-middle table-hover text-nowrap" style="border-color:#d0e2f2;">
          <thead style="background:#eef6ff;color:#35689b;">
            <tr>
              <th>ID</th>
              <th>Nome</th>
              <th>Tipo</th>
              <th>Especificação</th>
              <th>Fabricante</th>
              <th>Modelo</th>
              <th>Norma</th>
              <th>Unidade</th>
              <th class="text-center">Ações</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let p of pecas; trackBy: trackByPeca"
                [class.table-active]="editId === p.id"
                [class.editing]="editId === p.id"><!-- <- habilita quebra apenas na linha em edição -->

              <!-- ID -->
              <td>
                <ng-container *ngIf="editId !== p.id; else edit_id">
                {{ p.id }}
                </ng-container>
                  <ng-template #edit_id>
                    <input class="form-control form-control-sm"
                      [(ngModel)]="edit.id"
                      [attr.name]="'id_' + (p.id ?? p.id)"
                      autocomplete="off">
                  </ng-template>
              </td>

              <!-- Nome -->
              <td>
                <ng-container *ngIf="editId !== p.id; else edit_nome">
                  {{ p.nome.charAt(0).toUpperCase() + p.nome.slice(1) }}
                </ng-container>
                <ng-template #edit_nome>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.nome"
                         (blur)="capitalizar('nome')"
                         [attr.name]="'nome_' + (p.id ?? p.id)">
                </ng-template>
              </td>

              <!-- Tipo -->
              <td>
                <ng-container *ngIf="editId !== p.id; else edit_tipo">
                   {{ p.tipo ? (p.tipo.charAt(0).toUpperCase() + p.tipo.slice(1)) : '' }}
                </ng-container>
                <ng-template #edit_tipo>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.tipo"
                         [attr.name]="'tipo_' + (p.id ?? p.id)">
                </ng-template>
              </td>

              <!-- Especificação -->
              <td>
                <ng-container *ngIf="editId !== p.id; else edit_especificacao">
                  {{ p.especificacao | uppercase }}
                </ng-container>
                <ng-template #edit_especificacao>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.especificacao"
                         [attr.name]="'especificacao_' + (p.id ?? p.id)">
                </ng-template>
              </td>

              <!-- Fabricante -->
              <td>
                <ng-container *ngIf="editId !== p.id; else edit_fabricante">
                  {{ p.fabricante.charAt(0).toUpperCase() + p.fabricante.slice(1) }}
                </ng-container>
                <ng-template #edit_fabricante>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.fabricante"
                         [attr.name]="'fabricante_' + (p.id ?? p.id)">
                </ng-template>
              </td>

              <!-- Modelo -->
              <td>
                <ng-container *ngIf="editId !== p.id; else edit_modelo">
                  {{ p.modelo ? (p.modelo.charAt(0).toUpperCase() + p.modelo.slice(1)) : '' }}
                </ng-container>
                <ng-template #edit_modelo>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.modelo"
                         [attr.name]="'modelo_' + (p.id ?? p.id)">
                </ng-template>
              </td>

              <!-- Norma -->
              <td>
                <ng-container *ngIf="editId !== p.id; else edit_norma">
                  {{ p.norma | uppercase }}
                </ng-container>
                <ng-template #edit_norma>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.norma"
                         [attr.name]="'norma_' + (p.id ?? p.id)">
                </ng-template>
              </td>

              <!-- Unidade -->
              <td>
                <ng-container *ngIf="editId !== p.id; else edit_unidade">
                  {{ p.unidade.charAt(0).toUpperCase() + p.unidade.slice(1) }}
                </ng-container>
                <ng-template #edit_unidade>
                  <input class="form-control form-control-sm"
                         [(ngModel)]="edit.unidade"
                         [attr.name]="'unidade_' + (p.id ?? p.id)">
                </ng-template>
              </td>

              <!-- Ações -->
              <td class="text-center" style="min-width: 160px;">
                <ng-container *ngIf="editId !== p.id; else edit_acoes">
                  <button class="btn btn-sm btn-outline-primary me-1"
                          (click)="iniciarEdicao(p)"
                          style="border-color:#8fb4da;color:#35689b;">
                    Editar
                  </button>
                  <button class="btn btn-sm btn-outline-danger"
                          (click)="excluir(p.id)"
                          style="border-color:#f3c7c7;color:#b03030;">
                    Excluir
                  </button>
                </ng-container>
                <ng-template #edit_acoes>
                  <button class="btn btn-sm btn-success me-1"
                          (click)="salvarEdicao(p.id!)">
                    Salvar
                  </button>
                  <button class="btn btn-sm btn-secondary"
                          (click)="cancelarEdicao()">
                    Cancelar
                  </button>
                </ng-template>
              </td>

            </tr>

            <!-- Sem dados -->
            <tr *ngIf="!pecas || pecas.length === 0">
              <td colspan="15" class="text-center text-muted py-4">
                Nenhuma peça encontrada.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<style>
  /* Bordas/cores padrão */
  .table thead th { border-color: #d0e2f2 !important; }
  .table td, .table th { vertical-align: middle; color: #35689b; }
  .table-hover tbody tr:hover { background-color: #f7fbff; }
  .table-active { --bs-table-bg: #f1f7ff; }

  /* Sem quebras e com elipse por padrão (uma linha por registro) */
  .table.text-nowrap th,
  .table.text-nowrap td {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Linha em edição: mostrar todo o conteúdo (pode quebrar) */
  .table.text-nowrap tr.editing > th,
  .table.text-nowrap tr.editing > td {
    white-space: normal !important;
    overflow: visible !important;
    text-overflow: clip !important;
    word-break: break-word; /* ajuda com textos longos sem espaços */
  }

  /* Inputs na linha em edição com largura mínima confortável */
  .table.text-nowrap tr.editing .form-control {
    min-width: 220px;
  }

  .form-control:focus, .btn:focus {
    box-shadow: 0 0 0 .2rem rgba(53,104,155,.15);
    border-color: #8fb4da;
  }
</style>
